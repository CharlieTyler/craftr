<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- Code taken from https://gist.github.com/esBeee/545653241530f8f2c2e16371bec56f20 -->

    <% if Rails.env.production? %>
      <% unless user_signed_in? && current_user.admin %>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-117259081-1', 'auto');
          <% if action_name == "confirmation" %>
            ga('require', 'ecommerce');
            ga('ecommerce:addTransaction', {
              'id': '<%= @confirmed_order.id %>',
              'affiliation': 'CRAFTR', 
              'revenue':  '<%= @confirmed_order.total_paid_product_amount.to_f / 100 %>',
              'shipping':'<%= @confirmed_order.paid_shipping_price.to_f / 100 %>'
            });

            <% @confirmed_order.sold_items.each do |si| %>
              ga('ecommerce:addItem', {
                'id': '<%= @confirmed_order.id %>',
                'name': '<%= si.product.name %>', 
                'sku': '<%= si.product.id %>',
                'category': '<%= si.product.category.name %>',
                'price': '<%= si.item_price.to_f / 100 %>',
                'quantity': '<%= si.quantity %>'                   // Quantity.
              });
            <% end %>
            ga('ecommerce:send');
          <% end %>
        </script>
      <% end %>
    <% end %>

    <% if controller_name == "products" && action_name == "show" %>
      <%= render partial: 'products/structured_data_markup', locals: {product: @product} %>
    <% end %>
    <% if controller_name == "recipes" && action_name == "show" %>
      <%= render partial: 'recipes/structured_data_markup', locals: {recipe: @recipe} %>
    <% end %>

    <%= favicon_link_tag asset_path('favicon.png'), :rel => 'icon', :type =>  'image/png' %>

    <%= display_meta_tags site: 'CRAFTR' %>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <script src="https://cdn.quilljs.com/1.1.9/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.1.9/quill.snow.css" rel="stylesheet">
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
    <script src="https://js.stripe.com/v3/"></script>
    <%= tag :meta, :name => "stripe-key", :content => STRIPE_PUBLIC_KEY %>
    <meta name="viewport" content="initial-scale=1">
  </head>

  <body data-spy="scroll" data-target="#secondary-nav">
    <div id="flex-content-container">
      <% if controller_name == "static_pages" %>
        <div class = "container-fluid">
          <div class = "row background-secondary">
            <div class = "owl-carousel owl-theme top-nav-carousel">
              <div class = "text-center">
                <p class = "text-white my-1"><i class="fa fa-glass text-primary" aria-hidden="true"></i> &nbsp The finest craft spirits</p>
              </div>
              <div class = "text-center">
                <p class = "text-white my-1"><i class="fa fa-arrows-h text-primary" aria-hidden="true"></i> &nbsp Straight from the distillery</p>
              </div>
              <div class = "text-center">
                <p class = "text-white my-1"><i class="fa fa-truck text-primary" aria-hidden="true"></i> &nbsp £2 delivery</p>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <% if user_signed_in? && current_user.distillery.present? %>
        <div class = "container-fluid">
          <div class = "row background-secondary">
            <div class = "col-12 text-center">
              <p class = "text-white my-1"><%= link_to "Go to distiller portal", distiller_dashboard_path %></p>
            </div>
          </div>
        </div>
      <% end %>

      <% if user_signed_in? && current_user.admin %>
        <div class = "container-fluid">
          <div class = "row background-primary">
            <div class = "col-12 text-center">
              <p class = "text-white my-1"><%= link_to "Go to admin portal", admin_dashboard_path %></p>
            </div>
          </div>
        </div>
      <% end %>
      <%= render 'cookies_eu/consent_banner' %>

      
      <nav class="navbar navbar-toggleable-md navbar-light background-white mb-1">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <%= link_to root_path, class: "navbar-brand" do %>
          <%= image_tag "CraftrLogoPNG.png", height: '35', class: "d-inline-block align-top", alt: "Craftr logo" %>
        <% end %>
        <% unless action_name == "address" || action_name == "payment" %>
          <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item dropdown">
                <%= active_link_to "Spirits", products_path, active: [['products', 'categories'], []], class: "nav-link dropdown-toggle", :'data-toggle' => 'dropdown', :'aria-haspopup' => 'true', :'aria-expanded' => 'false' %>
                <div class="dropdown-menu">
                  <ul class = "no-bullet-list mx-0 px-0">
                    <% navbar_categories.each do |category| %>
                      <li><%= link_to category.name, category_path(category), class: "dropdown-item" %></li>
                    <% end %>
                  </ul>
                  <%= link_to "Randomise", random_product_path, class: "btn btn-primary mx-2 my-2", method: :post %>
                </div>
              </li>
              <li class="nav-item">
                <%= active_link_to "Distilleries", distilleries_path, class: "nav-link" %>
              </li>
              <li class="nav-item">
                <%= active_link_to "Recipes", recipes_path, class: "nav-link" %>
              </li>
              <li class="nav-item">
                <%= active_link_to "Articles", articles_path, class: "nav-link" %>
              </li>
              <li class="nav-item">
                <%= active_link_to "Bloggers", authors_path, class: "nav-link" %>
              </li>
            </ul>
            <ul class="navbar-nav float-right">
              <li class = "nav-item">
                <div class = "search-show-hide">
                  <%= form_tag search_path, method: :get, class: "form-inline mt-1 nav-item" do %>
                    <%= text_field_tag :keyword, nil, :placeholder => "Search for products, recipes and articles...", class: "form-control search-box mr-sm-2", type: "search" %>
                    <%= submit_tag "Search", class: "btn btn-secondary my-2 my-sm-0" %>
                  <% end %>
                </div>
              </li>
              <li class = "nav-item">
                <a class = "nav-link"><i class="fa fa-search search-toggle text-primary fa-2x" aria-hidden="true"></i></a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-2x text-primary fa-user-circle-o" aria-hidden="true"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <% if user_signed_in? %>
                    <%= link_to 'My account', me_path, class: 'dropdown-item' %>
                    <%= link_to 'Sign out', destroy_user_session_path, method: :delete, class: 'dropdown-item' %>
                  <% else %>
                    <%= link_to 'Sign in', new_user_session_path, class: 'dropdown-item' %>
                    <%= link_to 'Sign up', new_user_registration_path, class: 'dropdown-item' %>
                  <% end %>
                </div>
              </li>
              <li class = "nav-item">
                <%= link_to cart_path do %>
                  <p class = "nav-link mb-0 pb-0"><i class="fa fa-shopping-cart fa-2x <%= 'text-primary' if @order.order_items.length > 0 %>"></i></p>
                <% end %>
              </li>
              <% if @order.total_unpaid_quantity > 0 %>
                <li class = "nav-item">
                  <%= link_to cart_path do %>
                    <p class = "nav-link py-0 my-0">
                      <%= pluralize(@order.total_unpaid_quantity, 'item') %>
                      <br />
                      <%= number_to_currency((@order.total_unpaid_product_amount.to_f / 100), unit: "£") %>
                    </p>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        <% else %>
          <ul class="navbar-nav mr-auto ml-auto">
            <li class="nav-item">
              <i class="fa fa-lock" aria-hidden="true"></i> Secure checkout
            </li>
          </ul>
        <% end %>
      </nav>
      <!-- Age verification Modal -->
      <div class="modal fade" id="ageVerificationModal" tabindex="-1" role="dialog" aria-labelledby="ageVerificationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="ageVerificationModalLabel">Please verify your age</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class = "row">
                <div class = "col-6">
                  <h4>Verify age</h4>
                  <p>I confirm that I am <span class = "text-primary">over the legal drinking age</span> in my country of residence</p>
                  <div class = "row">
                    <%= link_to  "Verify", age_verification_index_path, class: "btn btn-primary col-10 offset-1 my-1", method: :post, remote: true %>
                    <%= link_to "Do not verify", "https://www.drinkaware.co.uk/advice/how-to-reduce-your-drinking/", class: "btn btn-secondary col-10 offset-1 my-1" %>
                  </div>
                </div>
                <div class = "col-6">
                  <h4>Or log in</h4>
                  <div class = "row">
                    <%= link_to "Sign in", new_user_session_path, class: "btn btn-primary col-10 offset-1 my-1" %>
                    <%= link_to "Sign up", new_user_registration_path, class: "btn btn-secondary col-10 offset-1 my-1" %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% if notice.present? %>
        <p class="alert alert-info"><%= notice.html_safe %></p>
      <% end %>
      <% if alert.present? %>
        <p class="alert alert-danger"><%= alert %></p>
      <% end %>
      <%= yield %>
    </div>
    <div id="footer">
      <div class="container">
        <div class = "row">
          <div class = "col-md-6">
            <ul class = "no-bullet-list">
              <li><%= link_to 'About', about_path %></li>
              <% if user_signed_in? && current_user.admin %>
                <li><%= link_to 'Admin dashboard', admin_dashboard_path %></li>
              <% end %>
              <li><%= link_to 'Contact us', contact_path %></li>
              <li><%= link_to 'Privacy policy', privacy_policy_path %></li>
            </ul>
          </div>
          <div class = "col-md-6">
            <p class = "mb-0">Please drink responsibly. For the facts, visit: </p>
            <%= link_to "http://www.drinkaware.co.uk" do %>
              <%= image_tag "drink_aware_logo.jpg", class: "img-fluid drink-aware mt-0" %>
            <% end %>
          </div>
          <div class = "col-md-6">
            <%= render partial: "static_pages/email_sign_up", locals: { email_sign_up: @email_sign_up } %>
          </div>
        </div>
      </div>
    </div>
    <script>
      <% if session[:age_verified] != true && user_signed_in? == false && controller_name != "registrations" && controller_name != "sessions" %>
        $("#ageVerificationModal").modal('show');
      <% end %>
    </script>
  </body>
</html>