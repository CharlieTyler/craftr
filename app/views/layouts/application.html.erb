<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- Code taken from https://gist.github.com/esBeee/545653241530f8f2c2e16371bec56f20 -->

    <% if Rails.env.production? %>
      <% unless user_signed_in? && current_user.admin %>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-117259081-1', 'auto');
          <% if action_name == "confirmation" %>
            ga('require', 'ecommerce');
            ga('ecommerce:addTransaction', {
              'id': '<%= @confirmed_order.id %>',
              'affiliation': 'CRAFTR', 
              'revenue':  '<%= @confirmed_order.total_paid_product_amount.to_f / 100 %>',
              'shipping':'<%= @confirmed_order.paid_shipping_price.to_f / 100 %>'
            });

            <% @confirmed_order.sold_items.each do |si| %>
              ga('ecommerce:addItem', {
                'id': '<%= @confirmed_order.id %>',
                'name': '<%= si.product.name %>', 
                'sku': '<%= si.product.id %>',
                'category': '<%= si.product.category.name %>',
                'price': '<%= si.item_price.to_f / 100 %>',
                'quantity': '<%= si.quantity %>'                   // Quantity.
              });
            <% end %>
            ga('ecommerce:send');
          <% end %>
        </script>
      <% end %>
    <% end %>

    <% if controller_name == "products" && action_name == "show" %>
      <%= render partial: 'products/structured_data_markup', locals: {product: @product} %>
    <% end %>
    <% if controller_name == "recipes" && action_name == "show" %>
      <%= render partial: 'recipes/structured_data_markup', locals: {recipe: @recipe} %>
    <% end %>
    <% if controller_name == "articles" && action_name == "show" %>
      <%= render partial: 'articles/structured_data_markup', locals: {article: @article} %>
    <% end %>

    <%= favicon_link_tag asset_path('favicon.png'), :rel => 'icon', :type =>  'image/png' %>

    <%= display_meta_tags site: 'CRAFTR', reverse: true %>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <script src="https://cdn.quilljs.com/1.1.9/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.1.9/quill.snow.css" rel="stylesheet">
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
    <script src="https://js.stripe.com/v3/"></script>
    <%= tag :meta, :name => "stripe-key", :content => STRIPE_PUBLIC_KEY %>
    <meta name="viewport" content="initial-scale=1">
  </head>

  <body data-spy="scroll" data-target="#secondary-nav" 
    <% if content_for?(:body_attributes) %>
      <%= yield(:body_attributes) %> 
    <% end %>>
    <!-- Prevents turbolinks on recipe show to allow Whisk to work -->
    <!-- Don't think this currently works -->
    <% content_for(:body_attributes) do %>
      <% if controller_name == 'recipes' && action_name == 'show' %>
          data-turbolinks="false"
      <% end %>
    <% end %>
    <div id="flex-content-container">

      <!-- Above the dropdown navbar for mobile -->
      <div class = "hidden-md-up">
        <div class = "container-fluid background-grey py-2">
          <div class = "row">
            <div class = "col-4 text-center">
              <% if user_signed_in? %>
                <%= link_to me_path do %>
                  <strong>üôÇ Account</strong>
                <% end %>
              <% else %>
                <%= link_to new_user_registration_path do %>
                  <strong>ü§® Sign up</strong>
                <% end %>
              <% end %>
            </div>
            <div class = "col-4 text-center">
              <%= link_to cart_path do %>
                <strong>üõí Basket</strong>
                <% if @order.order_items.length > 0 %>
                  <span class = "badge badge-primary js-number-of-items"><%= @order.total_unpaid_quantity %></span>
                <% end %>
              <% end %>
            </div>
            <div class = "col-4 text-center">
              <%= link_to "www.instagram.com/craftrspirits" do %>
                <i class="fa fa-instagram" aria-hidden="true"></i><strong> 21k</strong>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <% if user_signed_in? && current_user.distillery.present? %>
        <div class = "container-fluid">
          <div class = "row background-secondary">
            <div class = "col-12 text-center">
              <%= link_to distiller_dashboard_path do %>
                <p class = "text-white py-1 my-0">Go to distiller dashboard <span class = "badge badge-primary"><%= current_user.distillery.number_of_notifications %></span></p>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <% if user_signed_in? && current_user.admin %>
        <div class = "container-fluid">
          <div class = "row background-primary">
            <div class = "col-12 text-center">
              <p class = "text-white my-1"><%= link_to "Go to admin portal", admin_dashboard_path %></p>
            </div>
          </div>
        </div>
      <% end %>
      <%= render 'cookies_eu/consent_banner' %>
      
      <nav class="navbar navbar-toggleable-md navbar-light background-white mb-1">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <%= link_to root_path, class: "navbar-brand" do %>
          <%= image_tag "CraftrLogoPNG.png", height: '40', class: "d-inline-block align-top", alt: "Craftr logo" %>
        <% end %>
        <% unless action_name == "address" || action_name == "payment" %>
          <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item dropdown">
                <%= active_link_to "üç∏ Products", products_path, active: [['products', 'categories'], []], class: "nav-link dropdown-toggle", :'data-toggle' => 'dropdown', :'aria-haspopup' => 'true', :'aria-expanded' => 'false' %>
                <div class="dropdown-menu">
                  <div class = "container">
                    <div class = "row">
                      <div class = "col-md-4">
                        <h4>üëª By spirit</h4>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% navbar_categories.each do |category| %>
                            <li><%= link_to category.name.pluralize, category_path(category), class: "dropdown-item" %></li>
                          <% end %>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h4>‚≠ê Our favourites</h4>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% featured_products.each do |product| %>
                            <li><%= link_to product.name, product_path(product), class: "dropdown-item" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", products_path, class: "text-muted dropdown-item" %></strong></li>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h4>üè∞ By distillery</h4>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% featured_distilleries.each do |distillery| %>
                            <li><%= link_to distillery.name, distillery_path(distillery), class: "dropdown-item" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", distilleries_path, class: "text-muted dropdown-item" %></strong></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item dropdown">
                <%= active_link_to "üìñ Recipes", recipes_path, active: [['recipes'], []], class: "nav-link dropdown-toggle", :'data-toggle' => 'dropdown', :'aria-haspopup' => 'true', :'aria-expanded' => 'false' %>
                <div class="dropdown-menu">
                  <div class = "container">
                    <div class = "row">
                      <div class = "col-md-4">
                        <h4>‚ù§Ô∏è Most popular</h4>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% popular_recipes.each do |recipe| %>
                            <li><%= link_to recipe.name, recipe_path(recipe), class: "dropdown-item" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", recipes_path, class: "text-muted dropdown-item" %></strong></li>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h4>üÜï Newest</h4>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% newest_recipes.each do |recipe| %>
                            <li><%= link_to recipe.name, recipe_path(recipe), class: "dropdown-item" %></li>
                          <% end %>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h4>‚úçÔ∏è Latest articles</h4>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% latest_articles.each do |article| %>
                            <li><%= link_to article.title, article_path(article), class: "dropdown-item" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", articles_path, class: "text-muted dropdown-item" %></strong></li>
                        </ul>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
            <ul class="navbar-nav mr-auto">
              <li class = "nav-item">
                <div class="input-group">
                  <%= form_tag search_path, method: :get, class: "form-inline mt-1 nav-item" do %>
                    <%= text_field_tag :keyword, nil, :placeholder => "Search for products, recipes and articles...", :size => 40, class: "form-control search-box", type: "search" %>
                    <span class="input-group-btn">
                      <%= submit_tag "Search", class: "btn btn-primary my-2 my-sm-0" %>
                    </span>
                  <% end %>
                </div>
              </li>
            </ul>
            <ul class = "navbar-nav float-right">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  üôÇ
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <% if user_signed_in? %>
                    <%= link_to 'My account', me_path, class: 'dropdown-item' %>
                    <%= link_to 'Sign out', destroy_user_session_path, method: :delete, class: 'dropdown-item' %>
                  <% else %>
                    <%= link_to 'Sign in', new_user_session_path, class: 'dropdown-item' %>
                    <%= link_to 'Sign up', new_user_registration_path, class: 'dropdown-item' %>
                  <% end %>
                </div>
              </li>
              <ul class = "navbar-nav js-cart-area">
                <!-- A slight hack - put in an extra ul as the wrapper for the javascript hook on add to basket -->
                <%= render partial: "order_items/cart_icon", locals: { order: @order } %>
              </ul>
            </ul>
          </div>
        <% else %>
          <ul class="navbar-nav mr-auto ml-auto">
            <li class="nav-item">
              üîí Secure checkout
            </li>
          </ul>
        <% end %>
      </nav>

      <!-- Age verification Modal -->
      <div class="modal fade" id="ageVerificationModal" tabindex="-1" role="dialog" aria-labelledby="ageVerificationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="ageVerificationModalLabel">Please verify your age</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class = "row">
                <div class = "col-6">
                  <h4>Verify age</h4>
                  <p>I confirm that I am <span class = "text-primary">over the legal drinking age</span> in my country of residence</p>
                  <div class = "row">
                    <%= link_to  "Verify", age_verification_index_path, class: "btn btn-primary col-10 offset-1 my-1", method: :post, remote: true, data: { disable_with: 'Verifying...'} %>
                    <%= link_to "Do not verify", "https://www.drinkaware.co.uk/advice/how-to-reduce-your-drinking/", class: "btn btn-secondary col-10 offset-1 my-1" %>
                  </div>
                </div>
                <div class = "col-6">
                  <h4>Or log in</h4>
                  <div class = "row">
                    <%= link_to "Sign in", new_user_session_path, class: "btn btn-primary col-10 offset-1 my-1" %>
                    <%= link_to "Sign up", new_user_registration_path, class: "btn btn-secondary col-10 offset-1 my-1" %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% if notice.present? %>
        <p class="alert alert-info"><%= notice.html_safe %></p>
      <% end %>
      <% if alert.present? %>
        <p class="alert alert-danger"><%= alert %></p>
      <% end %>
      <%= yield %>
    </div>
    <div id="footer">
      <div class="container">
        <div class = "row">
          <div class = "col-md-6">
            <ul class = "no-bullet-list">
              <li><%= link_to 'About', about_path %></li>
              <% if user_signed_in? && current_user.admin %>
                <li><%= link_to 'Admin dashboard', admin_dashboard_path %></li>
              <% end %>
              <li><%= link_to 'Contact us', contact_path %></li>
              <li><%= link_to 'Privacy policy', privacy_policy_path %></li>
            </ul>
          </div>
          <div class = "col-md-6">
            <p class = "mb-0">Please drink responsibly. For the facts, visit: </p>
            <%= link_to "http://www.drinkaware.co.uk" do %>
              <%= image_tag "drink_aware_logo.jpg", class: "img-fluid drink-aware mt-0" %>
            <% end %>
          </div>
          <div class = "col-md-6">
            <%= render partial: "static_pages/email_sign_up", locals: { email_sign_up: @email_sign_up } %>
          </div>
        </div>
      </div>
    </div>
    <script>
      <% if session[:age_verified] != true && user_signed_in? == false && controller_name != "registrations" && controller_name != "sessions" %>
        $("#ageVerificationModal").modal('show');
      <% end %>
    </script>
  </body>
</html>