<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- Code taken from https://gist.github.com/esBeee/545653241530f8f2c2e16371bec56f20 -->

    <% if Rails.env.production? %>
      <% unless user_signed_in? && current_user.admin %>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117259081-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-117259081-1');

          <% if action_name == "confirmation" %>
            // For google ad conversion tracking
            gtag('event', 'conversion', {
                'send_to': 'AW-734967162/2zcmCJrK06YBEPrqut4C',
                'value': 40.0,
                'currency': 'GBP',
                'transaction_id': ''
            });
            ga('require', 'ecommerce');
            ga('ecommerce:addTransaction', {
              'id': '<%= @confirmed_order.id %>',
              'affiliation': 'Craftr', 
              'revenue':  '<%= @confirmed_order.total_paid_product_amount.to_f / 100 %>',
              'shipping':'<%= @confirmed_order.paid_shipping_price.to_f / 100 %>'
            });

            <% @confirmed_order.sold_items.each do |si| %>
              ga('ecommerce:addItem', {
                'id': '<%= @confirmed_order.id %>',
                'name': '<%= si.product.name.titleize %>', 
                'sku': '<%= si.product.id %>',
                'category': '<%= si.product.category.name %>',
                'price': '<%= si.item_price.to_f / 100 %>',
                'quantity': '<%= si.quantity %>'                   // Quantity.
              });

            <% end %>
            ga('ecommerce:send');
          <% end %>
        </script>
      <% end %>
    <% end %>

    <% if controller_name == "products" && action_name == "show" %>
      <%= render partial: 'products/structured_data_markup', locals: {product: @product} %>
    <% end %>
    <% if controller_name == "recipes" && action_name == "show" %>
      <%= render partial: 'recipes/structured_data_markup', locals: {recipe: @recipe} %>
    <% end %>
    <% if controller_name == "articles" && action_name == "show" %>
      <%= render partial: 'articles/structured_data_markup', locals: {article: @article} %>
    <% end %>

    <%= favicon_link_tag asset_path('favicon.png'), :rel => 'icon', :type =>  'image/png' %>

    <%= display_meta_tags site: 'Craftr', reverse: true, separator: "&ndash;".html_safe %>
    <%= yield :other_meta_tags %>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all' %>
    <script src="https://cdn.quilljs.com/1.1.9/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.1.9/quill.snow.css" rel="stylesheet">
    <%= javascript_include_tag 'application' %>
    <script src="https://js.stripe.com/v3/"></script>
    <%= tag :meta, :name => "stripe-key", :content => STRIPE_PUBLIC_KEY %>
    <meta name="viewport" content="initial-scale=1">

    <script async="true" src="//widget.whisk.com/assets/whiskbutton.js" type="text/javascript"></script>

    <!-- Facebook Pixel Code -->
    <% if Rails.env.production? %>
      <% unless user_signed_in? && current_user.admin %>
        <script>
          !function(f,b,e,v,n,t,s)
          {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
          n.callMethod.apply(n,arguments):n.queue.push(arguments)};
          if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
          n.queue=[];t=b.createElement(e);t.async=!0;
          t.src=v;s=b.getElementsByTagName(e)[0];
          s.parentNode.insertBefore(t,s)}(window, document,'script',
          'https://connect.facebook.net/en_US/fbevents.js');
          fbq('init', '2216217245171191');
          fbq('track', 'PageView');
        </script>
        <noscript><img height="1" width="1" style="display:none"
          src="https://www.facebook.com/tr?id=2216217245171191&ev=PageView&noscript=1"
        /></noscript>
      <% end %>
    <% end %>
    <!-- End Facebook Pixel Code -->
  </head>

  <body data-spy="scroll" data-target="#secondary-nav" 
    <% if content_for?(:body_attributes) %>
      <%= yield(:body_attributes) %> 
    <% end %>>
    <div id="flex-content-container">

      <!-- Admin and distillery links -->
      <% if user_signed_in? && current_user.distillery.present? %>
        <div class = "container-fluid">
          <div class = "row background-secondary">
            <div class = "col-12 text-center">
              <%= link_to distiller_dashboard_path do %>
                <p class = "text-white py-1 my-0">Go to distiller dashboard <span class = "badge badge-primary"><%= current_user.distillery.number_of_notifications %></span></p>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <% if user_signed_in? && current_user.admin %>
        <div class = "container-fluid">
          <div class = "row background-primary">
            <div class = "col-12 text-center">
              <p class = "text-white my-1"><%= link_to "Go to admin portal", admin_dashboard_path %></p>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Above the dropdown navbar for mobile -->
      <div class = "hidden-md-up">
        <div class = "container-fluid background-lightgrey py-2">
          <div class = "row my-1">
            <div class = "col-4 text-center border-right-grey px-0 align-middle">
              <% if user_signed_in? %>
                <%= link_to me_path do %>
                  <h6 class = "mb-0"><i class="fa fa-lg fa-user" aria-hidden="true"></i></h6>
                <% end %>
              <% else %>
                <%= link_to new_user_registration_path do %>
                  <h6 class = "mb-0"><i class="fa fa-lg fa-user-plus" aria-hidden="true"></i></h6>
                <% end %>
              <% end %>
            </div>
            <div class = "col-4 text-center border-right-grey px-0 align-top">
              <%= link_to cart_path do %>
                <h6 class = "mb-0"><i class="fa fa-lg fa-shopping-cart" aria-hidden="true"></i>
                  <span class = "badge badge-success js-number-of-items mb-1"><%= @order.total_unpaid_quantity %></span></h6>
              <% end %>
            </div>
            <div class = "col-4 text-center px-0 align-top">
              <%= link_to "https://www.instagram.com/craftrspirits" do %>
                <h6 class = "mb-0"><i class="fa fa-lg fa-instagram" aria-hidden="true"></i> 21k</h6>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <nav class="navbar navbar-toggleable-md navbar-light background-white">
        <button class="navbar-toggler navbar-toggler-right text-center collapsed" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
          <span> </span>
          <span> </span>
          <span> </span>
          <p class = "navbar-menu-text"><small>MENU</small></p>
        </button>
        <%= link_to root_path, class: "navbar-brand" do %>
          <%= image_tag "CraftrLogoPNG.png", height: '40', class: "d-inline-block align-top", alt: "Craftr logo" %>
        <% end %>
        <% unless action_name == "address" || action_name == "payment" %>
          <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item dropdown">
                <%= active_link_to "Products", products_path, active: [['products', 'categories'], []], class: "nav-link dropdown-toggle", :'data-toggle' => 'dropdown', :'aria-haspopup' => 'true', :'aria-expanded' => 'false' %>
                <div class="dropdown-menu">
                  <div class = "container">
                    <div class = "row">
                      <div class = "col-md-4">
                        <h6 class = "mt-3 mt-md-0">By spirit</h6>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% navbar_categories.each do |category| %>
                            <li><%= link_to category.name.pluralize, category_path(category), class: "dropdown-item p-0" %></li>
                          <% end %>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h6 class = "mt-3 mt-md-0">Craftr collections</h6>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% navbar_collections.each do |collection| %>
                            <li><%= link_to collection.full_name, collection_path(collection), class: "dropdown-item" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", collections_path, class: "text-primary dropdown-item bold-text" %></strong></li>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h6 class = "mt-3 mt-md-0">Our favourites</h6>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% featured_products.each do |product| %>
                            <li><%= link_to product.name.titleize, product_path(product), class: "dropdown-item" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", products_path, class: "text-primary dropdown-item bold-text" %></strong></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item dropdown">
                <%= active_link_to "Recipes", recipes_path, active: [['recipes'], []], class: "nav-link dropdown-toggle", :'data-toggle' => 'dropdown', :'aria-haspopup' => 'true', :'aria-expanded' => 'false' %>
                <div class="dropdown-menu">
                  <div class = "container">
                    <div class = "row">
                      <div class = "col-md-4">
                        <h6 class = "mt-3 mt-md-0">Most popular</h6>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% popular_recipes.each do |recipe| %>
                            <li><%= link_to recipe.name, recipe_path(recipe), class: "dropdown-item p-0" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", recipes_path, class: "text-primary dropdown-item bold-text" %></strong></li>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h6 class = "mt-3 mt-md-0">Newest</h6>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% newest_recipes.each do |recipe| %>
                            <li><%= link_to recipe.name, recipe_path(recipe), class: "dropdown-item p-0" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", recipes_path, class: "text-primary dropdown-item bold-text" %></strong></li>
                        </ul>
                      </div>
                      <div class = "col-md-4">
                        <h6 class = "mt-3 mt-md-0">Latest articles</h6>
                        <ul class = "no-bullet-list mx-0 px-0">
                          <% latest_articles.each do |article| %>
                            <li><%= link_to article.title, article_path(article), class: "dropdown-item p-0" %></li>
                          <% end %>
                          <li><strong><%= link_to "See all", articles_path, class: "text-primary dropdown-item bold-text" %></strong></li>
                        </ul>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
            <ul class="navbar-nav mr-auto">
              <li class = "nav-item">
                <div class="input-group">
                  <%= form_tag search_path, method: :get, class: "form-inline mt-1 nav-item" do %>
                    <%= text_field_tag :keyword, nil, :placeholder => "Search for products, recipes and articles...", :size => 40, class: "form-control search-box", type: "search" %>
                    <span class="input-group-btn">
                      <%= submit_tag "Search", class: "btn btn-search my-2 my-sm-0" %>
                    </span>
                  <% end %>
                </div>
              </li>
            </ul>
            <div class = "hidden-sm-down">
              <ul class = "navbar-nav float-right">
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-lg fa-user" aria-hidden="true"></i>
                  </a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                    <% if user_signed_in? %>
                      <%= link_to 'My account', me_path, class: 'dropdown-item' %>
                      <%= link_to 'Sign out', destroy_user_session_path, method: :delete, class: 'dropdown-item' %>
                    <% else %>
                      <%= link_to 'Sign in', new_user_session_path, class: 'dropdown-item' %>
                      <%= link_to 'Sign up', new_user_registration_path, class: 'dropdown-item' %>
                    <% end %>
                  </div>
                </li>
                <ul class = "navbar-nav js-cart-area">
                  <!-- A slight hack - put in an extra ul as the wrapper for the javascript hook on add to basket -->
                  <%= render partial: "order_items/cart_icon", locals: { order: @order } %>
                </ul>
              </ul>
            </div>
          </div>
        <% else %>
          <ul class="navbar-nav mr-auto ml-auto">
            <li class="nav-item">
              ðŸ”’ Secure checkout
            </li>
          </ul>
        <% end %>
      </nav>

      <!-- Age verification Modal -->
      <div class="modal fade" id="ageVerificationModal" tabindex="-1" role="dialog" aria-labelledby="ageVerificationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="ageVerificationModalLabel">Verify age & accept cookies</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class = "row px-3">
                <div class = "col-12">
                  <div class = "row">
                    <div class = "col-6">
                      <div class = "row px-2">
                        <%= link_to "Sign in", new_user_session_path, class: "col-12 text-center btn btn-green-secondary my-1" %>
                      </div>
                    </div>
                    <div class = "col-6">
                      <div class = "row px-2">
                        <%= link_to "Sign up", new_user_registration_path, class: "col-12 text-center btn btn-green-secondary my-1" %>
                      </div>
                    </div>
                  </div>
                  <hr class = "lyst-line"/>
                  <p class = "mt-2">I confirm that I:
                    <ul>
                      <li>am <strong>over the legal drinking age</strong> in my country of residence</p></li>
                      <li><strong>accept the use of cookies</strong>, in accordance with the <%= link_to "privacy policy", privacy_policy_path %></li>
                    </ul>
                  </p>
                  <div class = "row">
                    <%= link_to "I'm afraid I can't do that", "https://www.drinkaware.co.uk/advice/how-to-reduce-your-drinking/", class: "col-12 text-center mt-2 mb-1" %>
                    <%= link_to  "I am 18+ and accept cookies", age_verification_index_path, class: "btn-lg btn-success text-center col-12 my-1", method: :post, remote: true, data: { disable_with: 'Verifying...'} %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class = "background-lightgrey">
        <div class = "container">
          <% if notice.present? %>
            <div class = "row pt-1">
              <div class="col-12 pb-0 mb-0 alert alert-info alert-dismissible fade show diplay-v-middle" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <p><%= notice.html_safe %></p>
              </div>
            </div>
          <% end %>
          <% if alert.present? %>
            <div class = "row pt-1">
              <div class="col-12 pb-0 mb-0 alert alert-warning alert-dismissible fade show" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <p class = "mb-0"><%= alert.html_safe %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <%= yield %>
    </div>
    <div id="footer" class = "pt-3">
      <div class="container">
        <div class = "row">
          <div class = "col-6 col-md-3">
            <h5 class = "text-white">Quick links</h5>
            <ul class = "no-bullet-list pl-0 text-white">
              <li><%= link_to 'About', about_path %></li>
              <li><%= link_to 'Contact us', contact_path %></li>
              <li><%= link_to 'Privacy policy', privacy_policy_path %></li>
              <li><%= link_to 'Deliveries and shipping', deliveries_and_shipping_path %></li>
              <li><%= link_to 'Returns and refunds', returns_and_refunds_path %></li>
            </ul>
          </div>
          <div class = "col-6 col-md-3 offset-md-6 display-v-middle">
            <%= link_to "http://www.drinkaware.co.uk" do %>
              <%= image_tag "drink_aware_logo.png", class: "img-fluid drink-aware mt-0" %>
            <% end %>
          </div>
        </div>
        <div class = "row">
          <div class = "col-12 text-center">
            <p class = "my-2 small">Â© Craftr Ltd, <%= Date.today.year %></p>
          </div>
        </div>
      </div>
    </div>
    <script>
      <% if session[:age_verified] != true && user_signed_in? == false && controller_name != "registrations" && controller_name != "sessions" %>
        $("#ageVerificationModal").modal('show');
      <% end %>
    </script>
  </body>
</html>